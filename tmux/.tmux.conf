# ══════════════════════════════════════════════════════════════
# TMUX CONFIGURATION
# ══════════════════════════════════════════════════════════════
# See ~/.tmux/README.md for full documentation and setup guide.
#
# Quick reference:
#   Prefix: ` (backtick)
#   Help:   ` h (popup with keybindings)
#   Save:   ` w (like vim :w)
#   List:   prefix + S (or `tls` in shell)

# ══════════════════════════════════════════════════════════════
# Core Settings
# ══════════════════════════════════════════════════════════════

# Prefix key: ` (backtick - single key, double-tap for literal)
unbind C-b
set -g prefix `
bind ` send-prefix

# Terminal colours: enable 256-colour and true colour (RGB) support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Mouse: enable for pane selection, scrolling, and resizing
set -g mouse on

# Extended mouse support for apps like glow
set -ga terminal-features 'xterm*:extkeys:mouse'

# Pass mouse wheel to apps using alternate screen (glow, k9s, etc.)
bind -n WheelUpPane if -F '#{alternate_on}' 'send-keys -M' 'if -F "#{mouse_any_flag}" "send -M" "copy-mode -e; send-keys -M"'
bind -n WheelDownPane if -F '#{alternate_on}' 'send-keys -M' 'send-keys -M'

# Indexing: start windows and panes at 1 (matches keyboard layout)
set -g base-index 1
setw -g pane-base-index 1

# Auto-renumber windows when one is closed (no gaps in numbering)
set -g renumber-windows on

# Bell monitoring: highlight windows when Claude Code needs attention (via hooks)
setw -g monitor-activity off
setw -g monitor-bell on
set -g visual-bell off                # Don't show message, just highlight

# Window naming: show directory name if shell, otherwise show command
setw -g automatic-rename on
setw -g automatic-rename-format '#{?#{==:#{pane_current_command},zsh},#{b:pane_current_path},#{pane_current_command}}'

# Performance: eliminate delay after pressing Escape (important for vim)
set -s escape-time 0

# History: 50,000 lines of scrollback per pane
set -g history-limit 50000

# Status bar refresh: every 2 seconds (for responsive CPU/RAM display)
set -g status-interval 2

# ══════════════════════════════════════════════════════════════
# Keybindings
# ══════════════════════════════════════════════════════════════
# Note: "M-" means Option/Alt key, "-n" means no prefix required

# Unbind keys to pass through to shell/apps (Ctrl+z suspend, etc.)
unbind -n C-z
unbind -n C-o
unbind -n C-p
unbind -n C-x

# ─────────────────────────────────────────
# Window (tab) navigation
# ─────────────────────────────────────────
bind -n M-[ previous-window          # Opt+[
bind -n M-] next-window              # Opt+]
bind -n C-Enter next-window          # Ctrl+Enter
bind -n C-S-Enter previous-window    # Ctrl+Shift+Enter

# Jump to window by number (requires prefix)
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5

# New window in current directory
bind -n M-t new-window -c "#{pane_current_path}"    # Opt+t

# Window operations (right-click menu alternatives)
bind -n M-r command-prompt -I "#{window_name}" "rename-window '%%'"    # Opt+r = rename
bind -n "M-{" swap-window -t -1 \; select-window -t -1                  # Opt+Shift+[ = swap left
bind -n "M-}" swap-window -t +1 \; select-window -t +1                  # Opt+Shift+] = swap right
bind -n M-x kill-window                                                # Opt+x = kill window

# ─────────────────────────────────────────
# Pane navigation and management
# ─────────────────────────────────────────
# Vim-style navigation (Opt+hjkl)
bind -n M-h select-pane -L           # Opt+h = left
bind -n M-j select-pane -D           # Opt+j = down
bind -n M-k select-pane -U           # Opt+k = up
bind -n M-l select-pane -R           # Opt+l = right

# Alternative navigation
bind -n C-, select-pane -L           # Ctrl+, = left
bind -n C-. select-pane -D           # Ctrl+. = down

# Split panes (new panes inherit current directory)
bind -n M-\\ split-window -h -c "#{pane_current_path}"    # Opt+\ = split right
bind -n "M-'" split-window -h -b -c "#{pane_current_path}"  # Opt+' = split left
bind -n M-- split-window -v -c "#{pane_current_path}"     # Opt+- = split down

# Pane operations
bind -n M-s kill-pane                # Opt+s = close pane
bind -n M-z resize-pane -Z           # Opt+z = toggle zoom (fullscreen)

# Swap panes (requires prefix)
bind H swap-pane -U
bind J swap-pane -D
bind K swap-pane -U
bind L swap-pane -D

# Resize panes (Opt+Shift+hjkl)
bind -n M-H resize-pane -L 5           # Opt+Shift+h = shrink left
bind -n M-J resize-pane -D 5           # Opt+Shift+j = shrink down
bind -n M-K resize-pane -U 5           # Opt+Shift+k = grow up
bind -n M-L resize-pane -R 5           # Opt+Shift+l = grow right

# ─────────────────────────────────────────
# Scroll mode (copy-mode)
# ─────────────────────────────────────────
# Enter scroll mode
bind -n M-v copy-mode                    # Opt+v = enter scroll mode
bind v copy-mode                         # prefix + v = enter scroll mode

# Use vi-style keys in copy mode
setw -g mode-keys vi

# Navigation in copy mode (vim-style)
bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi h send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right

# Page navigation
bind -T copy-mode-vi C-f send-keys -X page-down       # Ctrl+f = page down
bind -T copy-mode-vi C-b send-keys -X page-up         # Ctrl+b = page up
bind -T copy-mode-vi f send-keys -X page-down         # f = page down
bind -T copy-mode-vi b send-keys -X page-up           # b = page up

# Half-page navigation
bind -T copy-mode-vi C-d send-keys -X halfpage-down   # Ctrl+d = half page down
bind -T copy-mode-vi C-u send-keys -X halfpage-up     # Ctrl+u = half page up
bind -T copy-mode-vi d send-keys -X halfpage-down \; send-keys -X bottom-line   # d = half page down + cursor to bottom
bind -T copy-mode-vi u send-keys -X halfpage-up \; send-keys -X top-line   # u = half page up + cursor to top

# Jump to top/bottom
bind -T copy-mode-vi g send-keys -X history-top       # g = top of history
bind -T copy-mode-vi G send-keys -X history-bottom    # G = bottom of history

# Exit scroll mode
bind -T copy-mode-vi q send-keys -X cancel            # q = quit scroll mode
bind -T copy-mode-vi Escape send-keys -X cancel       # Esc = quit scroll mode

# ─────────────────────────────────────────
# Help
# ─────────────────────────────────────────
# Display keybinding reference popup (press Esc to close)
bind h display-popup -w 80 -h 48 "cat ~/.tmux/tmux-help.txt; read -sk1"    # prefix + h

# ─────────────────────────────────────────
# Window switcher with vim-style navigation (prefix + f)
# Navigation: j/k (up/down), g/G (first/last), f/b (page), d/u (half-page)
# Press / to start searching, Esc to return to navigation mode
# ─────────────────────────────────────────
bind f display-popup -w 95% -h 95% -E "\
  tmux list-windows -a -F '#{?#{@last-viewed},#{@last-viewed},0} #{session_name}:#{window_index} #{window_name}' | \
  sort -rn | cut -d' ' -f2- | \
  fzf --reverse --disabled --cycle \
      --prompt ': ' \
      --border=rounded \
      --border-label=' j/k up/down · g/G ends · f/b page · d/u ½pg · spc/⏎ sel · / search · q/esc quit · ^x close ' \
      --border-label-pos=bottom \
      --preview 'tmux capture-pane -ep -t \$(echo {} | cut -d\" \" -f1)' \
      --preview-window=right:70% \
      --bind 'j:down,k:up,g:first,G:last,q:abort,space:accept' \
      --bind 'f:page-down,b:page-up' \
      --bind 'enter:accept' \
      --bind 'd:half-page-down,u:half-page-up' \
      --bind 'change:transform:[[ \$FZF_PROMPT == \": \" ]] && echo \"clear-query\"' \
      --bind '/:enable-search+change-prompt(> )+unbind(j,k,g,G,f,b,d,u,q,space)' \
      --bind 'esc:transform:[[ \$FZF_PROMPT == \"> \" ]] && echo \"disable-search+clear-query+change-prompt(: )+rebind(j,k,g,G,f,b,d,u,q,space)\" || echo \"abort\"' \
      --bind 'ctrl-k:kill-line,ctrl-w:unix-line-discard' \
      --bind 'ctrl-x:execute-silent(tmux kill-window -t \$(echo {} | cut -d\" \" -f1))+reload(tmux list-windows -a -F \"#{?#{@last-viewed},#{@last-viewed},0} #{session_name}:#{window_index} #{window_name}\" | sort -rn | cut -d\" \" -f2-)' | \
  cut -d' ' -f1 | xargs -r tmux switch-client -t"

# ══════════════════════════════════════════════════════════════
# Status Bar (Dracula theme)
# ══════════════════════════════════════════════════════════════

set -g status-position top
set -g status-style 'bg=#282a36 fg=#f8f8f2'          # Dark background, light text
set -g status-left '#[fg=#cc6699,bold] #S '          # Session name in pink
set -g status-right '#{?window_zoomed_flag,#[fg=#f1fa8c]Z ,}#{battery_color_charge_bg}#[fg=#f8f8f2] #{battery_icon_status} #{battery_percentage} #{cpu_bg_color}#[fg=#f8f8f2] ⚙ #{cpu_percentage} #{ram_bg_color}#[fg=#f8f8f2] ☰ #{ram_percentage} #[bg=#6272a4,fg=#f8f8f2] %a %h-%d %H:%M '
set -g status-left-length 30
set -g status-right-length 100

# Window tabs: inactive=grey, active=purple highlight, bell=pink
setw -g window-status-format '#[fg=#6272a4]#{?window_bell_flag,#[fg=#ff79c6],} #I:#W '
setw -g window-status-current-format '#[fg=#282a36,bg=#bd93f9,bold] #I:#W '

# Pane borders: inactive=dark grey, active=purple
set -g pane-border-style 'fg=#44475a'
set -g pane-active-border-style 'fg=#bd93f9'

# Command prompt / message bar: purple background with light text
set -g message-style 'bg=#bd93f9 fg=#282a36 bold'
set -g message-command-style 'bg=#6272a4 fg=#f8f8f2'

# ══════════════════════════════════════════════════════════════
# Plugins (managed by TPM)
# ══════════════════════════════════════════════════════════════
# Install: prefix + I    Update: prefix + U    Clean: prefix + alt + u

set -g @plugin 'tmux-plugins/tpm'              # Plugin manager
set -g @plugin 'tmux-plugins/tmux-resurrect'   # Save/restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum'   # Auto-save sessions
set -g @plugin 'tmux-plugins/tmux-cpu'         # CPU/RAM monitoring
set -g @plugin 'tmux-plugins/tmux-battery'    # Battery status
set -g @plugin 'tmux-plugins/tmux-open'        # Open highlighted selection
set -g @plugin 'tmux-plugins/tmux-yank'        # System clipboard integration

# ─────────────────────────────────────────
# Resurrect configuration
# ─────────────────────────────────────────
# Capture pane contents (terminal output) when saving
set -g @resurrect-capture-pane-contents 'on'

# Auto-restore on tmux start
set -g @continuum-restore 'on'

# Save interval: every 1 minute (default is 15)
set -g @continuum-save-interval '1'

# ─────────────────────────────────────────
# tmux-cpu configuration
# ─────────────────────────────────────────
# Icons for different load levels
set -g @cpu_low_icon "="
set -g @cpu_medium_icon "≡"
set -g @cpu_high_icon "≣"

# CPU background colours (Dracula: cyan → purple → pink)
set -g @cpu_low_bg_color "#[bg=#264d5a]"       # Dark cyan
set -g @cpu_medium_bg_color "#[bg=#3d3b5c]"    # Dark purple
set -g @cpu_high_bg_color "#[bg=#503b50]"      # Dark pink

# Percentage format (no padding for consistent spacing)
set -g @cpu_percentage_format "%.0f%%"

# RAM icons for different load levels
set -g @ram_low_icon "="
set -g @ram_medium_icon "≡"
set -g @ram_high_icon "≣"

# RAM background colours (Dracula: green → teal → purple)
set -g @ram_low_bg_color "#[bg=#2a4a3a]"       # Dark green
set -g @ram_medium_bg_color "#[bg=#2d4a50]"    # Dark teal
set -g @ram_high_bg_color "#[bg=#443a5a]"      # Dark purple

# RAM percentage format (no padding for consistent spacing)
set -g @ram_percentage_format "%.0f%%"

# ─────────────────────────────────────────
# tmux-battery configuration
# ─────────────────────────────────────────
# Battery status icons (geometric, matches CPU/RAM style)
set -g @batt_icon_status_charged '■'
set -g @batt_icon_status_charging '▲'
set -g @batt_icon_status_discharging '▼'
set -g @batt_icon_status_attached '■'
set -g @batt_icon_status_unknown '?'

# Battery background colours (simple green/red)
set -g @batt_color_charge_primary_tier8 '#2a4a40'    # Dracula green (20%+)
set -g @batt_color_charge_primary_tier7 '#2a4a40'
set -g @batt_color_charge_primary_tier6 '#2a4a40'
set -g @batt_color_charge_primary_tier5 '#2a4a40'
set -g @batt_color_charge_primary_tier4 '#2a4a40'
set -g @batt_color_charge_primary_tier3 '#2a4a40'
set -g @batt_color_charge_primary_tier2 '#503030'    # Red (20% and below)
set -g @batt_color_charge_primary_tier1 '#503030'

# Post-save hook: split combined save file into per-session files
# This enables restoring individual sessions independently
set -g @resurrect-hook-post-save-all '~/.tmux/scripts/resurrect-split-sessions.sh'

# ─────────────────────────────────────────
# Session management keybindings
# ─────────────────────────────────────────
# Built-in resurrect bindings:
#   prefix + Ctrl+s = save all sessions
#   prefix + Ctrl+r = restore all sessions

# Quick save (prefix + w, like vim :w)
bind w run-shell ~/.tmux/plugins/tmux-resurrect/scripts/save.sh

# Custom bindings for per-session management:
# Session switcher with vim-style navigation (prefix + s)
# Navigation: j/k (up/down), g/G (first/last), f/b (page), d/u (half-page)
# Press / to start searching, Esc to return to navigation mode
# Ctrl+x kills session, Ctrl+u undoes the last kill
bind s display-popup -w 95% -h 95% -E "\
  tmux list-sessions -F '#{session_activity} #{session_name}' | \
  sort -rn | cut -d' ' -f2- | \
  fzf --reverse --disabled --cycle \
      --prompt ': ' \
      --border=rounded \
      --border-label=' j/k · g/G · f/b · d/u · spc/⏎ sel · / srch · q/esc · r rename · ^x kill · ^u undo ' \
      --border-label-pos=bottom \
      --preview 'tmux capture-pane -ep -t {}' \
      --preview-window=right:70% \
      --bind 'j:down,k:up,g:first,G:last,q:abort,space:accept' \
      --bind 'f:page-down,b:page-up' \
      --bind 'enter:accept' \
      --bind 'd:half-page-down,u:half-page-up' \
      --bind 'change:transform:[[ \$FZF_PROMPT == \": \" ]] && echo \"clear-query\"' \
      --bind '/:enable-search+change-prompt(> )+unbind(j,k,g,G,f,b,d,u,q,space,r)' \
      --bind 'esc:transform:[[ \$FZF_PROMPT == \"> \" ]] && echo \"disable-search+clear-query+change-prompt(: )+rebind(j,k,g,G,f,b,d,u,q,space,r)\" || echo \"abort\"' \
      --bind 'ctrl-k:kill-line,ctrl-w:unix-line-discard' \
      --bind 'ctrl-x:execute-silent(~/.tmux/scripts/fzf-kill-session.sh {})+reload(tmux list-sessions -F \"#{session_activity} #{session_name}\" | sort -rn | cut -d\" \" -f2-)' \
      --bind 'ctrl-u:execute-silent(~/.tmux/scripts/fzf-undo-session.sh)+reload(tmux list-sessions -F \"#{session_activity} #{session_name}\" | sort -rn | cut -d\" \" -f2-)' \
      --bind 'r:become(~/.tmux/scripts/fzf-rename-session.sh {})' | \
  xargs -r tmux switch-client -t"
bind S display-popup -E -w 60 -h 20 "~/.tmux/scripts/resurrect-restore-session.sh --list; echo ''; read -n1 -p 'Press any key...'"
bind R command-prompt -p "Restore session:" "run-shell '~/.tmux/scripts/resurrect-restore-session.sh %%'"
# prefix + S = list saved session backups (popup)
# prefix + R = restore specific session (prompts for name)

# ─────────────────────────────────────────
# Auto-cleanup on session close
# ─────────────────────────────────────────
# When a session is killed, trigger a save to update backups
# This removes the killed session from tls listings
set-hook -g session-closed 'run-shell -b "sleep 0.5 && ~/.tmux/plugins/tmux-resurrect/scripts/save.sh && ~/.tmux/scripts/resurrect-split-sessions.sh"'

# ─────────────────────────────────────────
# Window access tracking
# ─────────────────────────────────────────
# Update @last-viewed timestamp when switching windows for fuzzy finder sorting
set-hook -g after-select-window 'run-shell -b "~/.tmux/scripts/update-window-timestamp.sh #{window_id}"'
set-hook -g client-session-changed 'run-shell -b "~/.tmux/scripts/update-window-timestamp.sh #{window_id}"'

# ══════════════════════════════════════════════════════════════
# Plugin Manager Initialisation (must be at bottom)
# ══════════════════════════════════════════════════════════════
run '~/.tmux/plugins/tpm/tpm'
