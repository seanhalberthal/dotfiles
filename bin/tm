#!/usr/bin/env bash
set -euo pipefail

# Dev session launcher - creates a 3-window layout for development

# Default to current directory if no argument provided
dir="${1:-$(pwd)}"

# Resolve to absolute path
dir=$(cd "$dir" && pwd)

# Validate directory exists
if [[ ! -d "$dir" ]]; then
    echo "Error: Directory not found: $dir" >&2
    exit 1
fi

# Use directory basename as session name (sanitised)
session=$(basename "$dir" | tr -c '[:alnum:]_.-' '_')

# Check if session already exists
if tmux has-session -t "$session" 2>/dev/null; then
    if [[ -n "${TMUX:-}" ]]; then
        tmux switch-client -t "$session"
    else
        tmux attach-session -t "$session"
    fi
    exit 0
fi

# Create new session with development layout
tmux new-session -d -s "$session" -n "dev" -c "$dir"

# Window 1: Split for Claude (left) and terminal (right)
tmux split-window -t "$session:1" -h -c "$dir"
tmux send-keys -t "$session:1.1" 'claude' Enter

# Window 2: Neovim
tmux new-window -t "$session" -n "edit" -c "$dir"
tmux send-keys -t "$session:2" 'nvim' Enter

# Select first window, first pane
tmux select-window -t "$session:1"
tmux select-pane -t "$session:1.1"

# Attach to session
if [[ -n "${TMUX:-}" ]]; then
    tmux switch-client -t "$session"
else
    tmux attach-session -t "$session"
fi
